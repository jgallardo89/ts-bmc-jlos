<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mappers.perfil.MapPerfil">
	<select id="obtenerPerfiles" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.PerfilVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.PerfilVO">		
		SELECT P.TX_PERFIL AS descripcionPerfil,
		  P.ST_PERFIL      AS estatusPerfil,
		  P.Cd_Perfil      As idPerfil,
		  P.Nb_Perfil      As nombrebPerfil,
		  O.Nb_St_Objeto As descipcionEstatus
		From Tgm504_Perfil P,
		  Tgm534_St_Objeto o
		Where P.St_Perfil  = O.Cd_St_Objeto
		<if test="descipcionEstatus != null and descipcionEstatus!=0">
			and St_Perfil = #{descipcionEstatus}	
		</if>
	</select>
	<insert id="insertarPermiso" keyProperty="idPantalla" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.ControlPermisoVO">
		<selectKey keyProperty="idControlPermiso" resultType="int" order="BEFORE"> 
			<![CDATA[ select SQ_CTRLPERMISO.nextval as idControlPermiso from dual ]]> 
		</selectKey>
		Insert Into Tgm505_Ctrlpermiso
		(
		  Cd_Perfil,
		  Cd_Componente,
		  Cd_Ctrl_Permiso
		)
		Values
		(
		  #{idPerfil},
		  #{idComponente},
		  #{idControlPermiso}
		)
	</insert>
	<update id="actualizarPerfil" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.PerfilVO">
		Update Tgm504_Perfil Set 
			Nb_Perfil = #{nombrebPerfil},
			Tx_Perfil = #{descripcionPerfil},
			St_Perfil = #{estatusPerfil}
		where Cd_Perfil = #{idPerfil}
	</update>
	<delete id="eliminarPermisos" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.ControlPermisoVO">
		Delete Tgm505_Ctrlpermiso
		Where Cd_Componente = #{idComponente} 
			  and Cd_Perfil = #{idPerfil}
	</delete>
	<insert id="insertarPerfil" keyProperty="idPantalla" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.PerfilVO">
		<selectKey keyProperty="idPerfil" resultType="int" order="BEFORE"> 
			<![CDATA[ select SQ_PERFIL.nextval as idPerfil from dual ]]> 
		</selectKey>
		Insert Into Tgm504_Perfil
		(
			Cd_Perfil,
			Nb_Perfil,
			Tx_Perfil,
			St_Perfil
		)
		Values 
		(
			#{idPerfil},
			#{nombrePerfil},
			#{descripcionPerfil},
			#{estatusPerfil}
		)
	</insert>
	<select id="obtenerPermisos" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.ControlPermisoVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.ControlPermisoVO">	
			SELECT Componente.Nb_Componente nombreComponente,
			  Componente.Cd_Default idDefault,
			  'true' permiso
			FROM Tgm505_Ctrlpermiso Control,
			  Tgm503_Usuario Usuario,
			  Tgm504_Perfil Perfil,
			  Tgm502_Componente Componente,
			  Tgm501_Pantalla Pantalla
			WHERE Control.Cd_Perfil      = Perfil.Cd_Perfil
			AND Usuario.Cd_Perfil        = Perfil.Cd_Perfil
			AND Componente.Cd_Componente = Control.Cd_Componente
			AND Componente.Cd_Pantalla   = Pantalla.Cd_Pantalla
			AND Perfil.Cd_Perfil         = #{idPerfil}
			AND Usuario.Cd_Usuario       = #{idUsuario}
			AND Pantalla.Cd_Pantalla     = #{idPantalla}
			UNION
			SELECT Componente.Nb_Componente nombreComponente,
			  Componente.Cd_Default idDefault,
			  'true' ermiso
			FROM Tgm502_Componente Componente,
			  Tgm501_Pantalla Pantalla
			Where Componente.Cd_Pantalla = Pantalla.Cd_Pantalla
			And Pantalla.Cd_Pantalla   = {idPantalla}
			And Componente.Cd_Default = 'T'	
</select>
</mapper>