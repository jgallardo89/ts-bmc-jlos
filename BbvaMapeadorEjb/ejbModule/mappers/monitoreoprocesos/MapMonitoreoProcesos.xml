<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mappers.monitoreoprocesos.MapMonitoreoProcesos">
	<select id="obtenerMonitoreoProcesosVO" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO">
		SELECT 
			P.CD_CONTRATACION idContratacion,
	        CAN.CD_CANAL idCanal,
	        CAN.NB_CANAL nombreCanal,
	        CLIENTE.CD_CLIENTE idCliente,
	        CLIENTE.CD_IDENTIFICADOR idIdentificador,
	        PRODUCTO.CD_PRODUCTO idProducto,
	        PRODUCTO.NB_PRODUCTO nombreProducto,
	        P.NU_LOTE numeroLote,
	        ARCHIVO.FH_REG_ARCH_ENTRA fechaLote,
	        ARCHIVO.CD_REG_ARCH_ENTRA idRegArchEntra,
	        ARCHIVO.NB_REG_ARCH_ENTRA nombreRegArchEntra,
	        P.TM_ST_PROCESO_INI horaProcesoIni,
	        P.TM_ST_PROCESO_FIN horaProcesoFin,
			P.FH_ST_PROCESO fechaStatusProceso,
			FLUJO.CD_FLUJO idFlujo,
			FLUJO.NB_FLUJO nombreFlujo,
			ETAPA.CD_ETAPA idEtapa,
			ETAPA.NB_ETAPA nombreEtapa,
			P.CD_ST_MAPEADOR idEstatusMapeador,
			ESTATUS.NB_ST_OBJETO nombreEstatusMapeador
		FROM  TGM522_ST_PROCESO P 
	        LEFT OUTER JOIN TGM536_REG_ARCH_EN ARCHIVO ON 
	        P.CD_REG_ARCH_ENTRA = ARCHIVO.CD_REG_ARCH_ENTRA 
			LEFT OUTER JOIN TGM534_ST_OBJETO ESTATUS ON 
	        P.CD_ST_MAPEADOR = ESTATUS.CD_ST_OBJETO 
	        LEFT OUTER JOIN TGM520_CONTRAT_MAP CM ON 
	        P.CD_CONTRATACION = cm.cd_contratacion AND  
	        P.CD_FLUJO = CM.CD_FLUJO AND 
	        P.CD_ETAPA = CM.CD_ETAPA
	        LEFT OUTER JOIN TGM518_FLUJOETAPA FE ON 
	        CM.CD_FLUJO = FE.CD_FLUJO AND
	        CM.CD_ETAPA = CM.CD_ETAPA
	        LEFT OUTER JOIN  TGM513_FLUJO FLUJO ON
	        FE.CD_FLUJO = FLUJO.CD_FLUJO
	        LEFT OUTER JOIN  TGM517_ETAPA ETAPA ON
	        FE.CD_ETAPA = ETAPA.CD_ETAPA
	        LEFT OUTER JOIN TGM519_CNTRATACION C ON 
	        CM.CD_CONTRATACION = C.CD_CONTRATACION
	        LEFT OUTER JOIN TGM511_CANAL CAN ON
	        C.CD_CANAL = CAN.CD_CANAL
	        LEFT OUTER JOIN TGM515_PRODUCTO PRODUCTO ON
	        C.CD_PRODUCTO = PRODUCTO.CD_PRODUCTO
	        LEFT OUTER JOIN TGM512_CLIENTE CLIENTE ON
	        C.CD_CLIENTE = CLIENTE.CD_CLIENTE
		WHERE 
	        P.CD_CONTRATACION IS NOT NULL  
		<if test="idCanal != null and idCanal != 0">
			AND CAN.CD_CANAL = #{idCanal}
		</if>		
		<if test="idCliente != null and idCliente != 0">
			AND CLIENTE.CD_CLIENTE = #{idCliente}
		</if>	
		<if test="idProducto != null and idProducto != 0">
			AND PRODUCTO.CD_PRODUCTO = #{idProducto}
		</if>	
		<if test="numeroLote != null and numeroLote != 0">
			AND P.NU_LOTE = #{numeroLote}
		</if>
		<if test="estados != null">
			AND P.CD_ST_MAPEADOR IN
			<foreach item="item" index="index" collection="estados"
	             open="(" separator="," close=")">
	        		#{item}
	   		</foreach> 
		</if>
		<if test="fechaInicio != null and fechaFin != null">    
			AND P.FH_ST_PROCESO BETWEEN #{fechaInicio} AND #{fechaFin}
		</if>
		ORDER BY CAN.CD_CANAL
	</select>
	<select id="obtenerRegistrosProceso" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO">
		SELECT 
			P.CD_CONTRATACION idContratacion,
	        CAN.CD_CANAL idCanal,
	        CAN.NB_CANAL nombreCanal,
	        CLIENTE.CD_CLIENTE idCliente,
	        CLIENTE.CD_IDENTIFICADOR idIdentificador,
	        PRODUCTO.CD_PRODUCTO idProducto,
	        PRODUCTO.NB_PRODUCTO nombreProducto,
	        P.NU_LOTE numeroLote,
	        ARCHIVO.FH_REG_ARCH_ENTRA fechaLote,
	        ARCHIVO.CD_REG_ARCH_ENTRA idRegArchEntra,
	        ARCHIVO.NB_REG_ARCH_ENTRA nombreRegArchEntra,
	        P.TM_ST_PROCESO_INI horaProcesoIni,
	        P.TM_ST_PROCESO_FIN horaProcesoFin,
			P.FH_ST_PROCESO fechaStatusProceso,
			FLUJO.CD_FLUJO idFlujo,
			FLUJO.NB_FLUJO nombreFlujo,
			ETAPA.CD_ETAPA idEtapa,
			ETAPA.NB_ETAPA nombreEtapa,
			P.CD_ST_MAPEADOR idEstatusMapeador,
			ESTATUS.NB_ST_OBJETO nombreEstatusMapeador
		FROM  TGM522_ST_PROCESO P 
	        LEFT OUTER JOIN TGM536_REG_ARCH_EN ARCHIVO ON 
	        P.CD_REG_ARCH_ENTRA = ARCHIVO.CD_REG_ARCH_ENTRA 
			LEFT OUTER JOIN TGM534_ST_OBJETO ESTATUS ON 
	        P.CD_ST_MAPEADOR = ESTATUS.CD_ST_OBJETO 
	        LEFT OUTER JOIN TGM520_CONTRAT_MAP CM ON 
	        P.CD_CONTRATACION = CM.CD_CONTRATACION AND  
	        P.CD_FLUJO = CM.CD_FLUJO AND 
	        P.CD_ETAPA = CM.CD_ETAPA
	        LEFT OUTER JOIN TGM518_FLUJOETAPA FE ON 
	        CM.CD_FLUJO = FE.CD_FLUJO AND
	        CM.CD_ETAPA = CM.CD_ETAPA
	        LEFT OUTER JOIN  TGM513_FLUJO FLUJO ON
	        FE.CD_FLUJO = FLUJO.CD_FLUJO
	        LEFT OUTER JOIN  TGM517_ETAPA ETAPA ON
	        FE.CD_ETAPA = ETAPA.CD_ETAPA
	        LEFT OUTER JOIN TGM519_CNTRATACION C ON 
	        CM.CD_CONTRATACION = C.CD_CONTRATACION
	        LEFT OUTER JOIN TGM511_CANAL CAN ON
	        C.CD_CANAL = CAN.CD_CANAL
	        LEFT OUTER JOIN TGM515_PRODUCTO PRODUCTO ON
	        C.CD_PRODUCTO = PRODUCTO.CD_PRODUCTO
	        LEFT OUTER JOIN TGM512_CLIENTE CLIENTE ON
	        C.CD_CLIENTE = CLIENTE.CD_CLIENTE
		WHERE 
	        P.CD_CONTRATACION = #{idContratacion} AND
	        P.CD_FLUJO =  #{idFlujo} AND 
	        P.CD_ETAPA = #{idEtapa}  AND	        
	        P.NU_LOTE = #{numeroLote} AND
	        to_char(P.FH_ST_PROCESO,'dd/MM/yyyy') = to_char(#{fechaStatusProceso},'dd/MM/yyyy')
	</select>
	<select id="obtenerEdosArchivoVO" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.EdoArchivoVO">
		SELECT 
			EDO.CD_REG_ARCH_ENTRA idRegArchEntra, 
			EDO.CD_EDO_ARCHIVO idEdoArchivo, 
			EDO.CD_ESTADO_ARCHIVO idEstadoArchivo, 
			EDO.TM_ESTADO_ARCHIVO horaEstadoArchivo, 
			EDO.FH_ESTADO_ARCHIVO fechaEstadoArchivo, 
			EDO.CD_ST_OBJETO idEstatusObjeto,
			O.NB_ST_OBJETO nombreEstatusObjeto,
			ESTADO.NB_ESTADO_ARCHIVO nombreEstadoArchivo
		FROM 
			TGM537_EDO_ARCHIVO EDO 
			INNER JOIN TGM538_ESTADO_ARCH ESTADO 
			ON EDO.CD_ESTADO_ARCHIVO = ESTADO.CD_ESTADO_ARCHIVO 
			INNER JOIN TGM534_ST_OBJETO O 
			ON EDO.CD_ST_OBJETO = O.CD_ST_OBJETO
		WHERE
		    EDO.CD_REG_ARCH_ENTRA =  #{idRegArchEntra}
		    
	</select>
	<update id="actualizarEstatusProceso" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO">
		UPDATE TGM522_ST_PROCESO 
		SET 
			CD_ST_MAPEADOR = 36
		WHERE 
			CD_CONTRATACION = #{idContratacion} and 
			CD_FLUJO =  #{idFlujo} and 
			CD_ETAPA = #{idEtapa} and			
	        NU_LOTE = #{numeroLote} and
	        to_char(FH_ST_PROCESO,'dd/MM/yyyy') = to_char(#{fechaStatusProceso},'dd/MM/yyyy')
	</update>
	<select id="obtieneCanalesProcesos" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO">
		select unique cn.cd_canal idCanal,
		  canal.nb_canal nombreCanal,
		  cn.cd_cliente idCliente,
		  cliente.nb_corto_cliente nombreCliente,
		  cn.cd_producto idProducto,
		  producto.nb_producto nombreProducto,
		  stp.fh_st_proceso fechaStatusProceso,
		  stp.nu_lote numeroLote   		  
		FROM tgm522_st_proceso stp,
		  tgm519_cntratacion cn,
		  tgm536_reg_arch_en ra,
		  tgm517_etapa eta,
		  tgm511_canal canal,
		  tgm512_cliente cliente,
		  tgm515_producto producto
		WHERE stp.cd_contratacion = cn.cd_contratacion
		AND stp.cd_reg_arch_entra  = ra.cd_reg_arch_entra (+)
		and stp.cd_etapa          = eta.cd_etapa
		and canal.cd_canal  = cn.cd_canal
		and cliente.cd_cliente  = cn.cd_cliente
		and producto.cd_producto  = cn.cd_producto
		<if test="idCanal != null and idCanal != 0">
			AND cn.CD_CANAL = #{idCanal}
		</if>		
		<if test="idCliente != null and idCliente != 0">
			AND cn.CD_CLIENTE = #{idCliente}
		</if>	
		<if test="idProducto != null and idProducto != 0">
			AND cn.CD_PRODUCTO = #{idProducto}
		</if>	
		<if test="numeroLote != null and numeroLote != 0">
			AND stp.NU_LOTE = #{numeroLote}
		</if>		
		<if test="fechaInicio != null and fechaFin != null">    
			AND to_date(stp.FH_ST_PROCESO,'dd-MM-rrrr') BETWEEN to_date(#{fechaInicio},'dd-MM-rrrr') AND to_date(#{fechaFin},'dd-MM-rrrr')
		</if>
		<if test="tipoReporte == 1">
			ORDER BY cn.cd_canal,
			  cn.cd_cliente,
			  cn.cd_producto	
		</if>
		<if test="tipoReporte == 2">
			ORDER BY cn.cd_cliente,
			  cn.cd_canal,
			  cn.cd_producto	
		</if>
		<if test="tipoReporte == 3">
			ORDER BY cn.cd_producto,
			  cn.cd_canal,
			  cn.cd_cliente			  	
		</if>
	</select>
	<select id="obtieneEtapasArchivos" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO">
		SELECT stp.cd_Contratacion idContratacion, 
		  cn.cd_canal idCanal,
		  cn.cd_cliente idCliente,
		  cn.cd_producto idProducto,
		  stp.cd_etapa idEtapa,
		  stp.cd_flujo idFlujo,
		  stp.fh_st_proceso fechaStatusProceso,
		  stp.nu_lote numeroLote,
		  eta.nb_etapa nombreEtapa,
		  stp.cd_Reg_Arch_Entra idRegArchEntra,
		  nvl(ra.nb_reg_arch_entra,'') nombreRegArchEntra,
		  to_char(stp.tm_st_proceso_ini,'HH:mm:ss') fechaInicio,
		  to_char(stp.tm_st_proceso_fin,'HH:mm:ss') fechaFin,
		  stp.cd_st_mapeador idEstatusMapeador		  
		FROM tgm522_st_proceso stp,
		  tgm519_cntratacion cn,
		  tgm536_reg_arch_en ra,
		  tgm517_etapa eta,
		  tgm518_flujoetapa flujoEtapa
		WHERE stp.cd_contratacion = cn.cd_contratacion
		AND stp.cd_reg_arch_entra = ra.cd_reg_arch_entra (+) 
		and stp.cd_etapa          = eta.cd_etapa
		and flujoEtapa.cd_etapa = stp.cd_etapa
    	and flujoEtapa.cd_flujo = stp.cd_flujo
		and cn.cd_canal = #{idCanal}
		and cn.cd_cliente = #{idCliente} 
		and cn.cd_producto = #{idProducto}
		and stp.nu_lote = #{numeroLote}
		and to_char(stp.fh_st_proceso,'dd/MM/yyyy') = to_char(#{fechaStatusProceso},'dd/MM/yyyy')		
		<if test="estados != null">
				AND stp.CD_ST_MAPEADOR IN
			<foreach item="item" index="index" collection="estados"
	             open="(" separator="," close=")">
	        		#{item}
	   		</foreach>
	   	</if>
		ORDER BY cn.cd_canal,
		  cn.cd_cliente,
		  cn.cd_producto,
		  stp.nu_lote,		
		  stp.fh_st_proceso,  
		  flujoEtapa.nu_orden_etapa	
	</select>
	<select id="obtieneEstatusProceso" parameterType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO"
		resultType="mx.com.bbva.bancomer.bussinnes.model.vo.MonitoreoProcesosVO">
			SELECT unique stp.cd_st_mapeador idEstatusMapeador
			FROM tgm522_st_proceso stp,
			  tgm519_cntratacion cn,
			  tgm536_reg_arch_en ra,
			  tgm517_etapa eta
			WHERE stp.cd_contratacion = cn.cd_contratacion
			AND stp.cd_reg_arch_entra = ra.cd_reg_arch_entra (+)
			AND stp.cd_etapa          = eta.cd_etapa
			and cn.cd_canal = #{idCanal}
			and cn.cd_cliente = #{idCliente} 
			and cn.cd_producto = #{idProducto}
			and stp.nu_lote = #{numeroLote}
			and to_char(stp.fh_st_proceso,'dd/MM/yyyy') = to_char(#{fechaStatusProceso},'dd/MM/yyyy')					
	</select>
</mapper>